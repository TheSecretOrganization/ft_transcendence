{% extends "./extends/base.html" %}

{% block content %}
<div class="container">
	<h1 class="text-center fw-bold">{{ name }}</h1>
	<h2 class="text-start fs-4 fw-bold mb-3">Players</h2>
	<table id="players" class="table table-striped table-bordered">
		<tbody></tbody>
	</table>

	<h2 class="text-start fs-4 fw-bold mb-3">Next Round</h2>
	<table id="next-round" class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>Player 1</th>
				<th>Player 2</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<h2 class="text-start fs-4 fw-bold mb-3">History</h2>
	<table id="history" class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>ID</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<button id="lock-btn" class="btn btn-primary hidden" disabled>Lock</button>
	<button id="mix-btn" class="btn btn-success hidden" disabled>Mix</button>
</div>

<script>
	const socket = wsConnect(wsCreateUrl("pong_tournament", { "name": "{{ name }}" }), onMessage, exit);
	const lockBtn = document.getElementById("lock-btn");
	const mixBtn = document.getElementById("mix-btn");
	const playersTbl = document.getElementById("players");
	let gameWatchers = []

	function onMessage(data) {
		if (data?.type === undefined) {
			console.error("Invalid message from server ignored.");
			return;
		}

		switch (data.type) {
			case "join": handleJoin(data.players); break;
			case "creator": handleCreator(); break;
			case "mix": handleMix(data.player_pairs); break;
			case "next_round_id": route(`/pong/online/${data.id}/{{ name }}`); break;
			case "bye": displayToast("You have received a bye for this round. Enjoy the break!"); break;
			case "current_games": handleCurrentGames(data.current_games); break;
			case "history": handleHistory(data.history); break;
			default: console.error("Invalid message from server ignored."); break;
		}
	}

	function handleJoin(players) {
		const tableBody = document.querySelector("#players tbody");
		tableBody.innerHTML = '';

		players.forEach(element => {
			const row = document.createElement('tr');
			const player = document.createElement('td');
			player.textContent = element;
			row.appendChild(player);
			tableBody.appendChild(row);
		});
	}

	function handleCreator() {
		lockBtn.classList.remove("hidden");
		lockBtn.disabled = false;
	}

	function handleMix(playerPairs) {
		const tableBody = document.querySelector("#next-round tbody");
		tableBody.innerHTML = '';

		playerPairs.forEach(element => {
			const row = document.createElement('tr');
			const player1 = document.createElement('td');
			const player2 = document.createElement('td');
			player1.textContent = element[0];
			player2.textContent = element[1];
			row.appendChild(player1);
			row.appendChild(player2);
			tableBody.appendChild(row);
		});
	}

	function handleCurrentGames(currentGames) {
		closeWatchers();
		currentGames.forEach(id => {
			watcher = wsConnect(wsCreateUrl("pong", {
				"room_id": id,
				"watch": true,
			}), onWactherMessage, onWatcherError);
			watcher.id = id;
			gameWatchers.push(watcher);
		});
	}

	function handleHistory(history) {
		const tableBody = document.querySelector("#history tbody");
		tableBody.innerHTML = '';

		history.forEach(element => {
			const row = document.createElement('tr');
			const id = document.createElement('td');
			id.textContent = element;
			row.appendChild(id);
			tableBody.appendChild(row);
		});
	}

	function closeWatchers() {
		while (gameWatchers.length > 0) {
			watcher = gameWatchers.pop();
			watcher.close()
		}
	}

	function onWatcherError(e) {
		console.log(e);
		socket.send(JSON.stringify({ type: "close_game", "id": e.target.id }));
	}

	function onWactherMessage(data) {
		console.log(data);
		if (data?.type === undefined) {
			console.error("Invalid message from watcher ignored.");
			return;
		}

		switch (data.type) {
			case "game_state": handleGameState(); break;
			case "watcher_stop": handleWatcherStop(data.id); break;
			default: console.error("Invalid message from watcher ignored."); break;
		}
	}

	function handleGameState() {

	}

	function handleWatcherStop(id) {
		const index = gameWatchers.findIndex(watcher => watcher.id === id);
		if (index !== -1) {
			watcher = gameWatchers.splice(index, 1)[0];
			watcher.close();
			socket.send(JSON.stringify({"type": "archive", "id": id}));
		}
	}

	function exit(reroute = true) {
		closeWatchers();
		if (socket)
			socket.close();
		if (reroute)
			route("/tournament");
	}

	function onPageChange(e) {
		exit(false);
		e.srcElement.removeEventListener('pagechange', onPageChange);
	}

	lockBtn.onclick = () => {
		const tableBody = document.querySelector("#players tbody");
		const rowCount = tableBody.rows.length;
		if (rowCount < 2) {
			displayToast("You are alone in the tournament...");
			return;
		}
		lockBtn.classList.add("hidden");
		lockBtn.disabled = true;
		socket.send(JSON.stringify({ type: "lock" }));
		mixBtn.classList.remove("hidden");
		mixBtn.disabled = false;
	}

	mixBtn.onclick = () => {
		mixBtn.classList.add("hidden");
		mixBtn.disabled = true;
		socket.send(JSON.stringify({ type: "mix" }));
	}

	document.getElementById('content').addEventListener('pagechange', onPageChange);
</script>
{% endblock %}
